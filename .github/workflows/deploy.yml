name: CI/CD Pipeline - MS-Lotosia Backend

on:
  push:
    branches: [ master, staging, development ]
  pull_request:
    branches: [ master, staging, development ]

concurrency:
  group: ms-lotosia-backend-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  JAVA_VERSION: '17'
  DOCKER_BUILDKIT: 1
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}
  GITHUB_OWNER: ${{ github.repository_owner }}

jobs:
  detect-services:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      services_json: ${{ steps.detect.outputs.services_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: detect
        run: |
          all_services="api-gateway service-discovery identity-service content-service support-service product-service profile-service shopping-service payment-service media-service"

          shared_impact_regex='^(build\.gradle(\.kts)?|settings\.gradle(\.kts)?|gradle/|gradlew|gradlew\.bat|buildSrc/|libs/|infrastructure/|\.github/)'
          services_regex='^(api-gateway|service-discovery|identity-service|content-service|support-service|product-service|profile-service|shopping-service|payment-service|media-service)/'

          if git log -1 --pretty=%B | grep -qiE "\[rebuild\]|\[rebuild-all\]"; then
            changed_services="$all_services"
          else
            if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "$GITHUB_BASE_REF" ]; then
              git fetch origin "$GITHUB_BASE_REF" --depth=1 || true
              base_ref="origin/${GITHUB_BASE_REF}"
              head_ref="HEAD"
            else
              base_ref="${{ github.event.before }}"
              head_ref="${{ github.sha }}"
            fi

            changed_files=$(git diff --name-only "$base_ref" "$head_ref" 2>/dev/null || true)

            if echo "$changed_files" | grep -qE "$shared_impact_regex"; then
              changed_services="$all_services"
            else
              changed_services=$(echo "$changed_files" \
                | awk -F/ -v re="$services_regex" '$0 ~ re {print $1}' \
                | sort -u | sed '/^$/d')
            fi

            if [ -z "$changed_services" ]; then
              echo "services_json=[]" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          services_json=$(printf '%s\n' $changed_services | jq -R . | jq -s -c .)
          echo "services_json=$services_json" >> "$GITHUB_OUTPUT"

  build-and-test:
    name: Build and Test (Java Services)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-services
    if: ${{ needs.detect-services.outputs.services_json != '[]' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: Build & test changed Java services
        env:
          SERVICES_JSON: ${{ needs.detect-services.outputs.services_json }}
        run: |
          services=$(echo "$SERVICES_JSON" | jq -r '.[]')

          tasks=()
          for s in $services; do
            [ "$s" = "media-service" ] && continue
            tasks+=(":$s:build")
          done

          if [ ${#tasks[@]} -eq 0 ]; then
            echo "No Java services to build"
            exit 0
          fi

          ./gradlew "${tasks[@]}" --no-daemon --build-cache --parallel

  build-and-test-nodejs:
    name: Build and Test (Node.js Services)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: detect-services
    if: ${{ contains(fromJson(needs.detect-services.outputs.services_json), 'media-service') }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./media-service
        run: npm ci || npm install

  build-docker-images:
    name: Build Docker Images (Java Services)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [detect-services, build-and-test]
    if: github.event_name == 'push' && needs.detect-services.outputs.services_json != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-services.outputs.services_json) }}
        exclude:
          - service: media-service
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-docker
        with:
          registry: ${{ env.REGISTRY }}
          platforms: linux/amd64

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/ms-lotosia/${{ matrix.service }}
          tags: |
            type=sha
            type=raw,value=latest,enable=true

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  build-docker-images-nodejs:
    name: Build Docker Images (Node.js Services)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect-services, build-and-test-nodejs]
    if: |
      github.event_name == 'push' &&
      contains(fromJson(needs.detect-services.outputs.services_json), 'media-service')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-docker
        with:
          registry: ${{ env.REGISTRY }}
          platforms: linux/amd64

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/ms-lotosia/media-service
          tags: |
            type=sha
            type=raw,value=latest,enable=true

      - uses: docker/build-push-action@v5
        with:
          context: ./media-service
          file: ./media-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha,scope=media-service
          cache-to: type=gha,mode=max,scope=media-service