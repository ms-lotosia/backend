name: CI/CD Pipeline - MS-Lotosia Backend

on:
  push:
    branches: [ master, staging, development ]
  pull_request:
    branches: [ master, staging, development ]

concurrency:
  group: ms-lotosia-backend-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  JAVA_VERSION: '17'
  DOCKER_BUILDKIT: 1
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}
  GITHUB_OWNER: ${{ github.repository_owner }}

jobs:
  detect-services:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      services_json: ${{ steps.detect.outputs.services_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: detect
        run: |
          all_services="api-gateway service-discovery identity-service content-service support-service product-service profile-service shopping-service payment-service media-service"

          shared_impact_regex='^(build\.gradle(\.kts)?|settings\.gradle(\.kts)?|gradle/|gradlew|gradlew\.bat|buildSrc/|libs/|infrastructure/|\.github/|monitoring/)'
          services_regex='^(api-gateway|service-discovery|identity-service|content-service|support-service|product-service|profile-service|shopping-service|payment-service|media-service)/'

          if git log -1 --pretty=%B | grep -qiE "\[rebuild\]|\[rebuild-all\]"; then
            changed_services="$all_services"
          else
            if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "$GITHUB_BASE_REF" ]; then
              git fetch origin "$GITHUB_BASE_REF" --depth=1 || true
              base_ref="origin/${GITHUB_BASE_REF}"
              head_ref="HEAD"
            else
              base_ref="${{ github.event.before }}"
              head_ref="${{ github.sha }}"
            fi

            changed_files=$(git diff --name-only "$base_ref" "$head_ref" 2>/dev/null || true)

            if echo "$changed_files" | grep -qE "$shared_impact_regex"; then
              changed_services="$all_services"
            else
              changed_services=$(echo "$changed_files" \
                | awk -F/ -v re="$services_regex" '$0 ~ re {print $1}' \
                | sort -u | sed '/^$/d')
            fi

            if [ -z "$changed_services" ]; then
              echo "services_json=[]" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          services_json=$(printf '%s\n' $changed_services | jq -R . | jq -s -c .)
          echo "services_json=$services_json" >> "$GITHUB_OUTPUT"

  build-and-test:
    name: Build Java Services
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-services
    if: ${{ needs.detect-services.outputs.services_json != '[]' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: Build bootable JARs for changed services
        env:
          SERVICES_JSON: ${{ needs.detect-services.outputs.services_json }}
        run: |
          set -euo pipefail
          services=$(echo "$SERVICES_JSON" | jq -r '.[]')

          tasks=()
          for s in $services; do
            [ "$s" = "media-service" ] && continue
            tasks+=(":$s:bootJar")
          done

          if [ ${#tasks[@]} -eq 0 ]; then
            echo "No Java services to build"
            exit 0
          fi

          ./gradlew "${tasks[@]}" --no-daemon --build-cache --parallel

      - name: Prepare JARs for artifact upload (stable names, avoids -plain.jar)
        env:
          SERVICES_JSON: ${{ needs.detect-services.outputs.services_json }}
        run: |
          set -euo pipefail
          mkdir -p jars
          services=$(echo "$SERVICES_JSON" | jq -r '.[]')

          for s in $services; do
            [ "$s" = "media-service" ] && continue

            jar_dir="$s/build/libs"
            if [ ! -d "$jar_dir" ]; then
              echo "ERROR: JAR directory not found for $s: $jar_dir"
              exit 1
            fi

            jar_candidate="$(ls -1 "$jar_dir"/*.jar 2>/dev/null | grep -v -- '-plain\.jar$' | head -n 1 || true)"
            if [ -z "$jar_candidate" ]; then
              jar_candidate="$(ls -1 "$jar_dir"/*.jar 2>/dev/null | head -n 1 || true)"
            fi

            if [ -z "$jar_candidate" ]; then
              echo "ERROR: No JAR produced for $s. Contents of $jar_dir:"
              ls -la "$jar_dir" || true
              exit 1
            fi

            cp "$jar_candidate" "jars/$s.jar"
            echo "Prepared jars/$s.jar from $(basename "$jar_candidate")"
          done

      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: java-service-jars
          path: jars/
          retention-days: 1
          if-no-files-found: error

  build-and-test-nodejs:
    name: Build and Test (Node.js Services)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: detect-services
    if: ${{ contains(fromJson(needs.detect-services.outputs.services_json), 'media-service') }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./media-service
        run: npm ci || npm install

  build-docker-images:
    name: Build Docker Images (Java Services)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [detect-services, build-and-test]
    if: github.event_name == 'push' && needs.detect-services.outputs.services_json != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-services.outputs.services_json) }}
        exclude:
          - service: media-service
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Download JAR artifacts
        uses: actions/download-artifact@v4
        with:
          name: java-service-jars
          path: .

      - uses: ./.github/actions/setup-docker
        with:
          registry: ${{ env.REGISTRY }}
          platforms: linux/amd64

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/ms-lotosia/${{ matrix.service }}
          tags: |
            type=sha
            type=raw,value=latest,enable=true

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  build-docker-images-nodejs:
    name: Build Docker Images (Node.js Services)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect-services, build-and-test-nodejs]
    if: |
      github.event_name == 'push' &&
      contains(fromJson(needs.detect-services.outputs.services_json), 'media-service')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-docker
        with:
          registry: ${{ env.REGISTRY }}
          platforms: linux/amd64

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/ms-lotosia/media-service
          tags: |
            type=sha
            type=raw,value=latest,enable=true

      - uses: docker/build-push-action@v5
        with:
          context: ./media-service
          file: ./media-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=media-service
          cache-to: type=gha,mode=max,scope=media-service

  deploy-to-server:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-docker-images, build-docker-images-nodejs]
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref_name == 'main' || github.ref_name == 'master' || github.ref_name == 'development') &&
      (needs.build-docker-images.result == 'success') &&
      (needs.build-docker-images-nodejs.result == 'success' || needs.build-docker-images-nodejs.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          if [ -n "${{ secrets.DEPLOY_HOST_KEY }}" ]; then
            echo "${{ secrets.DEPLOY_HOST_KEY }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 600 ~/.ssh/known_hosts
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/deploy_key

      - name: Prepare remote directory
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"

      - name: Upload docker-compose.yml
        run: scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no infrastructure/docker-compose.yml ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/docker-compose.yml

      - name: Upload nginx configuration
        run: scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no infrastructure/nginx.conf ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/nginx.conf

      - name: Create SSL directory on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "mkdir -p ${{ secrets.DEPLOY_PATH }}/ssl"

      - name: Generate SSL certificates on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && \
             openssl req -x509 -newkey rsa:4096 -keyout ssl/selfsigned.key -out ssl/selfsigned.crt -days 365 -nodes -subj '/C=US/ST=State/L=City/O=Organization/CN=${{ secrets.DEPLOY_HOST }}' && \
             chmod 600 ssl/selfsigned.key && \
             chmod 644 ssl/selfsigned.crt && \
             ls -la ssl/"

      - name: Upload monitoring configuration
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}/monitoring"
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r monitoring/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Deploy services on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "echo '${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}' | docker login ${{ env.REGISTRY }} -u '${{ secrets.GHCR_USERNAME || github.actor }}' --password-stdin && \
             cd ${{ secrets.DEPLOY_PATH }} && \
             docker-compose pull && \
             docker-compose up -d --remove-orphans"

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && docker-compose ps"

      - name: Cleanup old images
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "docker image prune -a --filter 'until=168h' -f"

      - name: Cleanup SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          ssh-add -D 2>/dev/null || true
          