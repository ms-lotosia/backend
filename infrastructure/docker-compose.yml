services:

  postgres-identity:
    image: postgres:15-alpine
    container_name: postgres-identity
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: identity_db
    volumes:
      - postgres_identity_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  postgres-content:
    image: postgres:15-alpine
    container_name: postgres-content
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: content_db
    volumes:
      - postgres_content_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  postgres-support:
    image: postgres:15-alpine
    container_name: postgres-support
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: support_db
    volumes:
      - postgres_support_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  postgres-product:
    image: postgres:15-alpine
    container_name: postgres-product
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: product_db
    volumes:
      - postgres_product_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  postgres-profile:
    image: postgres:15-alpine
    container_name: postgres-profile
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: profile_db
    volumes:
      - postgres_profile_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  postgres-shopping:
    image: postgres:15-alpine
    container_name: postgres-shopping
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: shopping_db
    volumes:
      - postgres_shopping_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  postgres-payment:
    image: postgres:15-alpine
    container_name: postgres-payment
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: payment_db
    volumes:
      - postgres_payment_data:/var/lib/postgresql/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@ms-lotosia.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: "True"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "5050:80"
    networks: [microservices-network]
    depends_on:
      postgres-identity:
        condition: service_healthy
      postgres-content:
        condition: service_healthy
      postgres-support:
        condition: service_healthy
      postgres-product:
        condition: service_healthy
      postgres-profile:
        condition: service_healthy
      postgres-shopping:
        condition: service_healthy
      postgres-payment:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks: [microservices-network]
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3000}
      GF_SERVER_SERVE_FROM_SUB_PATH: ${GRAFANA_SERVE_FROM_SUB_PATH:-false}
      GF_SECURITY_COOKIE_SECURE: ${GRAFANA_COOKIE_SECURE:-false}
      GF_SECURITY_COOKIE_SAMESITE: "lax"
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    networks: [microservices-network]
    depends_on:
      prometheus:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru --tcp-keepalive 300
    volumes:
      - redis_data:/data
    networks: [microservices-network]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  mongodb:
    image: mongo:7-jammy
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: identity_db
    volumes:
      - mongodb_data:/data/db
    networks: [microservices-network]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    command: ["--redis.addr=redis://redis:6379"]
    networks: [microservices-network]
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'

  postgres-exporter-identity:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-identity
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-identity:5432/identity_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-identity:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  postgres-exporter-content:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-content
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-content:5432/content_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-content:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  postgres-exporter-support:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-support
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-support:5432/support_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-support:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  postgres-exporter-product:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-product
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-product:5432/product_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-product:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  postgres-exporter-profile:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-profile
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-profile:5432/profile_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-profile:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  postgres-exporter-shopping:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-shopping
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-shopping:5432/shopping_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-shopping:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  postgres-exporter-payment:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-payment
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres-payment:5432/payment_db?sslmode=disable
    networks: [microservices-network]
    depends_on:
      postgres-payment:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    volumes:
      - ./monitoring/blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    command:
      - '--config.file=/etc/blackbox_exporter/config.yml'
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks: [microservices-network]
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_HEAP_OPTS: "-Xms512m -Xmx1g"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
    networks: [microservices-network]
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29092"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  service-discovery:
    image: ghcr.io/ms-lotosia/ms-lotosia/service-discovery:latest
    container_name: service-discovery
    ports:
      - "8761:8761"
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gateway
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'

  api-gateway:
    image: ghcr.io/ms-lotosia/ms-lotosia/api-gateway:latest
    container_name: api-gateway
    expose:
      - "8080"
    depends_on:
      service-discovery:
        condition: service_started
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  identity-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/identity-service:latest
    container_name: identity-service
    depends_on:
      postgres-identity:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-identity:5432/identity_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  content-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/content-service:latest
    container_name: content-service
    depends_on:
      postgres-content:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-content:5432/content_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  support-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/support-service:latest
    container_name: support-service
    depends_on:
      postgres-support:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-support:5432/support_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_MAIL_HOST: smtp.gmail.com
      SPRING_MAIL_PORT: 587
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME:-your-email@gmail.com}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD:-your-app-password}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
      SPRING_MAIL_FROM: ${SPRING_MAIL_USERNAME:-your-email@gmail.com}
      SITE_TEAM_NOTIFICATION_EMAIL: ${SPRING_MAIL_USERNAME:-your-email@gmail.com}
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  product-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/product-service:latest
    container_name: product-service
    depends_on:
      postgres-product:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-product:5432/product_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  profile-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/profile-service:latest
    container_name: profile-service
    depends_on:
      postgres-profile:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-profile:5432/profile_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  shopping-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/shopping-service:latest
    container_name: shopping-service
    depends_on:
      postgres-shopping:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-shopping:5432/shopping_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_KAFKA_CONSUMER_GROUP_ID: shopping-service-group
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  payment-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/payment-service:latest
    container_name: payment-service
    depends_on:
      postgres-payment:
        condition: service_healthy
      kafka:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-payment:5432/payment_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  media-service:
    image: ghcr.io/ms-lotosia/ms-lotosia/media-service:latest
    container_name: media-service
    ports:
      - "8085:8085"
    depends_on:
      service-discovery:
        condition: service_started
    networks: [microservices-network]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

volumes:
  postgres_identity_data:
  postgres_content_data:
  postgres_support_data:
  postgres_product_data:
  postgres_profile_data:
  postgres_shopping_data:
  postgres_payment_data:
  redis_data:
  mongodb_data:
  pgadmin_data:
  prometheus_data:
  grafana_data:

networks:
  microservices-network:
    driver: bridge
